name: CI Build & Deploy

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE: ${{ secrets.REGISTRY }}/portafolio:${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test || echo "No tests configured"

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Login to registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY_HOST }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: ${{ env.IMAGE }}

      - name: Run database migrations (on the pushed image)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          IMAGE: ${{ env.IMAGE }}
        run: |
          # Pull the image we just pushed and run migrations using Prisma
          docker pull $IMAGE
          docker run --rm -e DATABASE_URL="$DATABASE_URL" $IMAGE npx prisma migrate deploy

      - name: Optional: Deploy (example)
        if: false
        run: |
          echo "Add deployment steps here (SSH, cloud provider, or update stack)"

  # Nota: Para despliegue autom√°tico en production, crea un job que conecte
  # con tu servidor (SSH) o use el proveedor de cloud y actualice el servicio.
